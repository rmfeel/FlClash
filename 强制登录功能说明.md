# 强制登录功能说明

## 功能概述

Surfboard 应用现在要求用户必须先登录才能使用。未登录时会自动显示登录页面，登录成功后才能进入主界面。

## 主要特性

### 1. 启动时强制登录检查
- 应用启动时会检查用户登录状态
- 未登录：显示登录页面
- 已登录：直接进入主页

### 2. 登录流程
1. 输入邮箱和密码
2. 点击"登录"按钮
3. 登录成功后自动：
   - 保存认证 Token
   - 获取订阅信息
   - 下载 Clash 配置文件
   - 自动导入配置
   - 进入主页

### 3. 注册功能
- 新用户可以点击"立即注册"
- 注册成功后返回登录页面
- 需要重新登录

### 4. 忘记密码
- 点击"忘记密码?"
- 通过邮箱验证码重置密码

### 5. 退出登录
- 在"工具"页面找到"账户管理"部分
- 点击"退出登录"
- 确认后会清除登录状态
- 自动返回登录页面

## 技术实现

### 核心文件

#### 1. `lib/pages/auth_check_page.dart`
登录检查页面，作为应用的根页面：
```dart
- 检查 xboardConfigProvider 的登录状态
- 已登录：显示 HomePage
- 未登录：显示 LoginPage
- 自动响应登录状态变化
```

#### 2. `lib/application.dart`
应用入口修改：
```dart
- home: AuthCheckPage() (替代原来的 HomePage)
- 所有页面都需要通过 AuthCheckPage 检查
```

#### 3. `lib/views/auth/login_page.dart`
登录页面优化：
```dart
- 登录成功后不再使用 Navigator.pop()
- 依赖 Provider 状态变化自动切换页面
- 自动导入配置文件
```

#### 4. `lib/views/tools.dart`
工具页面添加账户管理：
```dart
- 账户信息项：显示当前登录邮箱
- 退出登录按钮：退出并返回登录页
- 退出前显示确认对话框
```

### 状态管理

使用 Riverpod 的 `xboardConfigProvider` 管理登录状态：
```dart
class XboardConfig {
  String? authToken;      // 认证 Token
  bool isLoggedIn;        // 是否已登录
  String? userEmail;      // 用户邮箱
}
```

登录状态变化会自动触发 `AuthCheckPage` 重新构建，实现页面切换。

## 用户流程

### 首次使用
```
1. 打开应用
2. 看到登录页面
3. 点击"立即注册"创建账号
4. 返回登录页面
5. 输入邮箱密码登录
6. 自动导入配置
7. 进入主页开始使用
```

### 日常使用
```
1. 打开应用
2. 自动检测到已登录
3. 直接进入主页
4. 正常使用所有功能
```

### 退出登录
```
1. 进入"工具"页面
2. 找到"账户管理"
3. 点击"退出登录"
4. 确认退出
5. 自动返回登录页
6. 需要重新登录才能使用
```

## 配置说明

### 修改后端地址
编辑 `lib/models/xboard_config.dart`:
```dart
const factory XboardConfig({
  @Default('http://127.0.0.1:8000') String baseUrl,  // 修改这里
  String? authToken,
  @Default(false) bool isLoggedIn,
  String? userEmail,
}) = _XboardConfig;
```

## 注意事项

1. **持久化存储**
   - 登录信息会自动保存到本地
   - 重启应用后保持登录状态
   - 使用 SharedPreferences 存储

2. **Token 管理**
   - Token 自动添加到所有 API 请求
   - Token 过期时需要重新登录
   - 退出登录会清除 Token

3. **配置自动导入**
   - 登录成功后自动下载 Clash 配置
   - 配置文件自动保存和导入
   - 导入失败不影响登录流程

4. **状态同步**
   - 登录/登出会立即反映到 UI
   - 无需手动刷新页面
   - 使用 Riverpod 自动管理状态

## 常见问题

### Q: 如何绕过登录？
A: 无法绕过，这是强制登录功能的设计目标。

### Q: 忘记密码怎么办？
A: 点击登录页的"忘记密码?"，通过邮箱验证码重置。

### Q: 可以同时登录多个账号吗？
A: 不可以，一次只能登录一个账号。需要切换账号时先退出登录。

### Q: 退出登录会删除配置文件吗？
A: 不会，只会清除登录状态和 Token，已导入的配置文件保留。

### Q: 登录信息会丢失吗？
A: 不会，登录信息持久化存储，除非手动退出登录或卸载应用。

## 构建说明

1. 确保所有文件已修改
2. 运行 `flutter pub get` 安装依赖
3. 运行代码生成：`flutter pub run build_runner build`
4. 构建应用（GitHub Actions 会自动构建）

## 版本信息

- 应用名称：Surfboard
- 包名：com.surfboard.app
- 支持平台：Android, iOS, Windows, macOS, Linux
